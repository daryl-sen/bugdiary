{% extends 'confined.html' %}
{% import 'macros.html' as macros %}

{% block addons %}{% endblock %}

{% block title %}
    BugDiary - {{project.name}} Dashboard
{% endblock %}

{% block custom_nav %}
{{ macros.project_nav(project) }}
{% endblock %}

{% block main %}
<h1>{{ project.name }}</h1>
<div class="main-aside">
    <main>
        <div class="block lined rounded text-centered bg-white">
            <div>
                <a href="{{ url_for('projects.view_bugs', project_url = project.url, view_type = 'cards') }}" class="button-secondary rounded shadowed">Cards view</a>
                <a href="{{ url_for('projects.view_bugs', project_url = project.url, view_type = 'tables') }}" class="button-secondary rounded shadowed">Table view</a>
                <a href="{{ url_for('core.redirect_to', project_url = project.url )}}" class="button-secondary rounded shadowed">Report</a>
            </div>
            <h3>Diary Stats</h3>
            {% set proj_stats = project.get_counters(current_user.last_login) %}
            <div class="block-comparison-3">
                <div class="comp1 text-centered lined bg-white">
                    <h4>Since Last Login</h4>
                    <span class="bignum">{{ proj_stats['since_last_login'] }}</span>
                </div>
                <div class="comp2 text-centered lined bg-white">
                    <h4>Total Resolved</h4>
                    <span class="bignum">{{ proj_stats['resolved'] }}</span>
                </div>
                <div class="comp3 text-centered lined bg-white">
                    <h4>Total Unresolved</h4>
                    <span class="bignum">{{ proj_stats['unresolved'] }}</span>
                </div>
            </div>

            

            <div style="text-align: left">
                <h3>Reporting Link</h3>
                <p>
                    Your testers or users can report bugs through the following link:
                    <input type="text" readonly value="https://www.bugdiary.com/r/{{ project.url }}">
                </p>
            </div>
        </div>

        <div class="spacer-small"></div>
        <h2>New Reports</h2>
        {% if new_reports != None %}
            {% for bug in new_reports %}
            {{ macros.bugcard(bug, False) }}
            {% endfor %}
        {% else %}
            <div class="bg-white rounded block">
                <b>- No new reports since your last login. - </b>
            </div>
        {% endif %}
    </main>
    <aside>
        <div class="sidebar-block bg-gray">
            <h3>Memo</h3>
            <p class="linebreak" id="memo-content">{{ project.memo }}</p>
            <div id="memo-editor" class="hidden">
                <textarea id="memo-new-content">{{ project.memo }}</textarea>
            </div>
            <button id="memo-edit-button" type="button" class="button-secondary rounded shadowed button-styled" onclick="edit_memo()">Edit</button type="button">
            <button id="memo-save-button" type="button" class="button-primary rounded shadowed button-styled hidden" onclick="save_memo('{{project.id}}');edit_memo()">Save</button type="button">
            
            <script>
                function edit_memo() {
                    toggleElement('memo-content');
                    toggleElement('memo-editor');
                    toggleElement('memo-edit-button');
                    toggleElement('memo-save-button');
                }

                

                function save_memo(project_id) {
                    var instructions = {
                        project: project_id,
                        content: document.getElementById('memo-new-content').value
                    };
                    // console.log(instructions);
                
                
                    fetch(`{{ url_for('projects.memo') }}`, {
                        method: "POST",
                        credentials: "include",
                        body: JSON.stringify(instructions),
                        cache: "no-cache",
                        headers: new Headers({
                            "content-type": "application/json"
                        })
                    })
                    .then(function(response) {
                    if (response.status !== 200) {
                        alert(`Looks like there was a problem. Status code: ${response.status}`);
                        return;
                    }
                    response.json().then(function(data) {
                        document.getElementById('memo-content').innerHTML = data['result'];
                    });
                    })
                    .catch(function(error) {
                        alert("Fetch error: " + error);
                    });
                }
            </script>
        </div>

        <div class="sidebar-block bg-gray">
            <h3>Useful Links</h3>
            <a href="{{ url_for('projects.settings', project_url = project.url) }}" class="navigation">Project Settings</a>
            <a href="{{ url_for('projects.location_and_type', project_url = project.url) }}" class="navigation">Bug locations and types</a>
            <a href="{{ url_for('projects.blog', project_url = project.url) }}" class="navigation">My Dev Blog</a>
            <a href="{{ url_for('projects.collaborators', project_url = project.url) }}" class="navigation">Collaborators</a>
        </div>
        {{ macros.ad(medium) }}
    </aside>
</div>
{% endblock %}